name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - production
          - staging
        default: "production"
      image_tag:
        description: "Docker image tag to deploy (e.g., main, v1.2.3)"
        required: true
        default: "main"
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy configuration files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,nginx/nginx.conf,nginx/conf.d/default-ssl.conf.example,nginx/conf.d/default-dev.conf.example,scripts/,observability/"
          target: "/tmp/bingoscape-deploy/"
          overwrite: true

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üöÄ Starting deployment to ${{ github.event.inputs.environment }}..."

            # Define application directory
            APP_DIR=~/bingoscape

            # Create application directory if it doesn't exist
            if [ ! -d "$APP_DIR" ]; then
              echo "üìÅ Creating application directory: $APP_DIR"
              mkdir -p "$APP_DIR"
            fi

            # Navigate to application directory
            cd "$APP_DIR"

            # Create uploads directory if it doesn't exist and set proper permissions
            echo "üìÅ Ensuring uploads directory exists with correct permissions..."
            if [ ! -d "$APP_DIR/uploads" ]; then
              mkdir -p "$APP_DIR/uploads"
              echo "Created new uploads directory"
            fi
            # Set proper permissions for uploads directory (UID 1001 = nextjs user in container)
            # Only set on directory itself, not recursively, to avoid permission errors on existing files
            # Files are managed by container and will inherit directory permissions
            sudo chown 1001:1001 "$APP_DIR/uploads" 2>/dev/null || chown 1001:1001 "$APP_DIR/uploads" || true
            sudo chmod 775 "$APP_DIR/uploads" 2>/dev/null || chmod 775 "$APP_DIR/uploads" || true
            echo "‚úÖ Uploads directory permissions set (owner: 1001:1001, mode: 775)"


            # Copy configuration files from temp location
            if [ -f "/tmp/bingoscape-deploy/docker-compose.yml" ]; then
              echo "üìã Copying docker-compose.yml to application directory..."
              cp /tmp/bingoscape-deploy/docker-compose.yml "$APP_DIR/"
              echo "‚úÖ docker-compose.yml copied successfully"
            else
              echo "‚ùå Error: docker-compose.yml not found in /tmp/bingoscape-deploy/"
              exit 1
            fi

            # Copy scripts directory
            if [ -d "/tmp/bingoscape-deploy/scripts" ]; then
              echo "üìã Copying scripts..."
              mkdir -p "$APP_DIR/scripts"
              cp -r /tmp/bingoscape-deploy/scripts/* "$APP_DIR/scripts/"
              chmod +x "$APP_DIR/scripts/"*.sh 2>/dev/null || true
              echo "‚úÖ Scripts copied and made executable"
            else
              echo "‚ö†Ô∏è  Warning: scripts directory not found, skipping..."
            fi

            # Copy observability configuration
            if [ -d "/tmp/bingoscape-deploy/observability" ]; then
              echo "üìã Copying observability configuration..."
              # Ensure directory exists with correct ownership before copying
              mkdir -p "$APP_DIR/observability"
              sudo chown -R $(whoami):$(whoami) "$APP_DIR/observability" 2>/dev/null || chown -R $(whoami):$(whoami) "$APP_DIR/observability" || true
              # Now copy files - will succeed since we own the directory
              cp -r /tmp/bingoscape-deploy/observability/* "$APP_DIR/observability/"
              echo "‚úÖ Observability configuration copied successfully"
            else
              echo "‚ö†Ô∏è  Warning: observability directory not found, skipping..."
            fi

            # Backup existing .env file
            if [ -f ".env" ]; then
              echo "üì¶ Backing up existing .env file..."
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # Generate .env file from GitHub secrets
            echo "üìù Generating .env file..."
            cat > .env << 'ENV_EOF'
            # Generated by GitHub Actions - $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            # Deployment: ${{ github.event.inputs.environment }}
            # Triggered by: ${{ github.actor }}

            # ==============================================
            # DATABASE CONFIGURATION
            # ==============================================
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_HOST="${{ secrets.DB_HOST }}"
            DB_PORT="${{ secrets.DB_PORT }}"

            # ==============================================
            # NEXTAUTH CONFIGURATION
            # ==============================================
            NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"

            # ==============================================
            # OAUTH PROVIDERS
            # ==============================================
            DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}"
            DISCORD_CLIENT_SECRET="${{ secrets.DISCORD_CLIENT_SECRET }}"

            # Optional OAuth providers
            GITHUB_CLIENT_ID="${{ secrets.GITHUB_CLIENT_ID }}"
            GITHUB_CLIENT_SECRET="${{ secrets.GITHUB_CLIENT_SECRET }}"
            GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"

            # ==============================================
            # APPLICATION CONFIGURATION
            # ==============================================
            SUPER_ADMIN_EMAILS="${{ secrets.SUPER_ADMIN_EMAILS }}"
            NODE_ENV=production

            # ==============================================
            # OBSERVABILITY & MONITORING
            # ==============================================
            GRAFANA_ADMIN_USER="${{ secrets.GRAFANA_ADMIN_USER }}"
            GRAFANA_ADMIN_PASSWORD="${{ secrets.GRAFANA_ADMIN_PASSWORD }}"
            GRAFANA_ROOT_URL="${{ secrets.GRAFANA_ROOT_URL }}"
            ALERT_EMAIL="${{ secrets.ALERT_EMAIL }}"
            ALERT_EMAIL_FROM="${{ secrets.ALERT_EMAIL_FROM }}"
            ALERT_DISCORD_WEBHOOK_URL="${{ secrets.ALERT_DISCORD_WEBHOOK_URL }}"
            SMTP_HOST="${{ secrets.SMTP_HOST }}"
            SMTP_PORT="${{ secrets.SMTP_PORT }}"
            SMTP_USER="${{ secrets.SMTP_USER }}"
            SMTP_PASSWORD="${{ secrets.SMTP_PASSWORD }}"
            METRICS_ENABLED="true"
            LOG_LEVEL="${{ secrets.LOG_LEVEL }}"
            PROMETHEUS_ENDPOINT="http://prometheus:9090"
            LOKI_ENDPOINT="http://loki:3100"

            # ==============================================
            # OPENTELEMETRY TRACING
            # ==============================================
            OTEL_EXPORTER_OTLP_ENDPOINT="http://tempo:4317"
            OTEL_SERVICE_NAME="bingoscape-next"
            OTEL_TRACES_SAMPLER="parentbased_traceidratio"
            OTEL_TRACES_SAMPLER_ARG="0.1"

            NEXT_SERVER_ACTIONS_ENCRYPTION_KEY="${{ secrets.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY }}"



            ENV_EOF

            echo "‚úÖ .env file generated successfully"

            # Log in to GHCR
            echo "üîê Logging in to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            # Pull latest Docker image
            echo "üì• Pulling Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
            docker compose pull

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker compose down

            # Start containers with new image
            echo "‚ñ∂Ô∏è  Starting containers..."
            docker compose --env-file ./.env up -d

            # Wait for containers to be healthy
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 10

            # Check container status
            echo "üìä Container status:"
            docker compose ps

            # Verify app is responding
            echo "üîç Verifying application health..."
            MAX_RETRIES=30
            RETRY_COUNT=0

            until curl -f http://localhost/api/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              echo "Waiting for application to respond... ($RETRY_COUNT/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 2
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "‚ö†Ô∏è  Warning: Application health check timed out"
              echo "üìã Checking application logs:"
              docker compose logs --tail=50 app
            else
              echo "‚úÖ Application is healthy and responding"
            fi

            # Show recent logs
            echo "üìã Recent application logs:"
            docker compose logs --tail=20 app

            # Clean up temporary files
            echo "üßπ Cleaning up temporary files..."
            rm -rf /tmp/bingoscape-deploy
            echo "‚úÖ Cleanup completed"

            echo "üéâ Deployment completed successfully!"

      - name: Post deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Notify deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment to ${{ github.event.inputs.environment }} completed successfully"
          else
            echo "‚ùå Deployment to ${{ github.event.inputs.environment }} failed"
            exit 1
          fi
