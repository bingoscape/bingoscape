name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'production'
      image_tag:
        description: 'Docker image tag to deploy (e.g., main, v1.2.3)'
        required: true
        default: 'main'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy configuration files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,nginx/nginx.conf,nginx/conf.d/default-ssl.conf.example"
          target: "/tmp/bingoscape-deploy/"
          overwrite: true

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "üöÄ Starting deployment to ${{ github.event.inputs.environment }}..."

            # Define application directory
            APP_DIR=~/bingoscape

            # Create application directory if it doesn't exist
            if [ ! -d "$APP_DIR" ]; then
              echo "üìÅ Creating application directory: $APP_DIR"
              mkdir -p "$APP_DIR"
            fi

            # Navigate to application directory
            cd "$APP_DIR"

            # Create uploads directory if it doesn't exist
            if [ ! -d "$APP_DIR/uploads" ]; then
              echo "üìÅ Creating uploads directory..."
              mkdir -p "$APP_DIR/uploads"
              # Set proper permissions for uploads (UID 1001 = nextjs user in container)
              sudo chown -R 1001:1001 "$APP_DIR/uploads" 2>/dev/null || chown -R 1001:1001 "$APP_DIR/uploads" || true
              chmod 755 "$APP_DIR/uploads"
              echo "‚úÖ Uploads directory created"
            fi

            # Copy configuration files from temp location
            if [ -f "/tmp/bingoscape-deploy/docker-compose.yml" ]; then
              echo "üìã Copying docker-compose.yml to application directory..."
              cp /tmp/bingoscape-deploy/docker-compose.yml "$APP_DIR/"
              echo "‚úÖ docker-compose.yml copied successfully"
            else
              echo "‚ùå Error: docker-compose.yml not found in /tmp/bingoscape-deploy/"
              exit 1
            fi

            # Copy nginx configuration if it exists
            if [ -d "/tmp/bingoscape-deploy/nginx" ]; then
              echo "üìã Copying nginx configuration..."
              mkdir -p "$APP_DIR/nginx/conf.d"

              # Copy main nginx.conf
              if [ -f "/tmp/bingoscape-deploy/nginx/nginx.conf" ]; then
                cp /tmp/bingoscape-deploy/nginx/nginx.conf "$APP_DIR/nginx/"
                echo "‚úÖ nginx.conf copied"
              fi

              # Copy SSL config and rename to default.conf for production
              if [ -f "/tmp/bingoscape-deploy/nginx/conf.d/default-ssl.conf.example" ]; then
                cp /tmp/bingoscape-deploy/nginx/conf.d/default-ssl.conf.example "$APP_DIR/nginx/conf.d/default.conf"
                echo "‚úÖ SSL configuration activated (default-ssl.conf.example ‚Üí default.conf)"
              fi

              echo "‚úÖ nginx configuration completed"
            else
              echo "‚ö†Ô∏è  Warning: nginx configuration not found, skipping..."
            fi

            # Backup existing .env file
            if [ -f ".env" ]; then
              echo "üì¶ Backing up existing .env file..."
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # Generate .env file from GitHub secrets
            echo "üìù Generating .env file..."
            cat > .env << 'ENV_EOF'
            # Generated by GitHub Actions - $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            # Deployment: ${{ github.event.inputs.environment }}
            # Triggered by: ${{ github.actor }}

            # ==============================================
            # DATABASE CONFIGURATION
            # ==============================================
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_HOST="${{ secrets.DB_HOST }}"
            DB_PORT="${{ secrets.DB_PORT }}"

            # ==============================================
            # NEXTAUTH CONFIGURATION
            # ==============================================
            NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"

            # ==============================================
            # OAUTH PROVIDERS
            # ==============================================
            DISCORD_CLIENT_ID="${{ secrets.DISCORD_CLIENT_ID }}"
            DISCORD_CLIENT_SECRET="${{ secrets.DISCORD_CLIENT_SECRET }}"

            # Optional OAuth providers
            GITHUB_CLIENT_ID="${{ secrets.GITHUB_CLIENT_ID }}"
            GITHUB_CLIENT_SECRET="${{ secrets.GITHUB_CLIENT_SECRET }}"
            GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
            GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"

            # ==============================================
            # APPLICATION CONFIGURATION
            # ==============================================
            SUPER_ADMIN_EMAILS="${{ secrets.SUPER_ADMIN_EMAILS }}"
            NODE_ENV=production

            # ==============================================
            # MONITORING & ERROR TRACKING
            # ==============================================
            SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}"
            SENTRY_DSN="${{ secrets.SENTRY_DSN }}"

            # ==============================================
            # SSL CERTIFICATE (for containerized nginx)
            # ==============================================
            CERTBOT_EMAIL="${{ secrets.CERTBOT_EMAIL }}"
            ENV_EOF

            echo "‚úÖ .env file generated successfully"

            # Log in to GHCR
            echo "üîê Logging in to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            # Pull latest Docker image
            echo "üì• Pulling Docker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}"
            docker compose pull

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker compose down

            # Start containers with new image
            echo "‚ñ∂Ô∏è  Starting containers..."
            docker compose --env-file ./.env up -d

            # Wait for containers to be healthy
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 10

            # Check container status
            echo "üìä Container status:"
            docker compose ps

            # Verify app is responding
            echo "üîç Verifying application health..."
            MAX_RETRIES=30
            RETRY_COUNT=0

            until curl -f http://localhost/api/health || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              echo "Waiting for application to respond... ($RETRY_COUNT/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 2
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "‚ö†Ô∏è  Warning: Application health check timed out"
              echo "üìã Checking application logs:"
              docker compose logs --tail=50 app
            else
              echo "‚úÖ Application is healthy and responding"
            fi

            # Show recent logs
            echo "üìã Recent application logs:"
            docker compose logs --tail=20 app

            # Clean up temporary files
            echo "üßπ Cleaning up temporary files..."
            rm -rf /tmp/bingoscape-deploy
            echo "‚úÖ Cleanup completed"

            echo "üéâ Deployment completed successfully!"

      - name: Post deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Notify deployment status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment to ${{ github.event.inputs.environment }} completed successfully"
          else
            echo "‚ùå Deployment to ${{ github.event.inputs.environment }} failed"
            exit 1
          fi
